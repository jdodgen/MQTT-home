# MIT license copyright 2026 Jim Dodgen
alertaway.com
home-broker - a small dedicated MQTT, fauxmo and zigbee server
it consolidates ZigBee and Internet/WiFi devices in a SQLite database.

a small http server exists: 
    1) maintain/map fauxmo devices
    2) provides a link zigbee2mqtt to maintain zigbee devices
    3) allow manual entry of custom IP devices
    4) collects nome-broker pub/sub devices 
    5) view consilodated devices and generated topics/payloads
    6) it can be used to test devices turn on and off
	7) ssh tunnel and server for camera jpg access
	8) MQTT email gateway
	9) timers sending on and off topics
	10) ...

It serves device information via pub/sub to extract devices from database
to be used by another automation system. This data is simplfied and 
formatted data including the pub/sub strings 

Hardware. 
SBC  pretty much anthing that can run Linux with Eathernet RJ45 
    and a USB port for the zigbee dongle if using zigbee2mqtt
 
here are the working dongles
https://www.zigbee2mqtt.io/guide/adapters/ 


# Test system: 
"Le Potato" (because RPI 3's were unavailble).
"SONOFF Zigbee 3.0 USB Dongle" (compatable and cheap)

# from:
https://github.com/n8henrie/fauxmo-plugins
# think about downloading  
mqttplugin.py 
# and place it here with the rest of the py code
sshpass -p foobar sftp -oBatchMode=no -b install_files.bat jim@192.168.0.193
# it might already be included
# install raspbian lite or linux distro of your choice

# we name this "home-broker" later
# you can access via http://home-broker.local  when on your LAN

# set login 

# if using raspian change the following in raspi-config:

sudo raspi-config

    # fix the following:
    # system option > host name "home-broker"
	# system > auto login (this system auto runs at boot
    #        to make debugging easier)
	# interface options > enable ssh
	# performance options > video memory as small as possable
	# localization set time zone
    # advanced options expand sd card 
	# when finished allow it to reboot

# now "putty in" from your computer to make things easier:

use home-broker.local for the address

sudo apt update    #  if problems run apt --fix-broken install
sudo apt upgrade
sudo apt install pip
sudo apt install mosquitto

sshpass -p foobar sftp -oBatchMode=no -b install_files.bat jim@192.168.0.193
# You do this IF we run it from main.py 
# right now we let it run by itsself

# not needed --- sudo systemctl disable mosquitto.service
# to start, monitor and restart mosquitto as needed 

# bring in the python packages

sudo pip install fauxmo --break-system-packages
sudo pip install paho.mqtt --break-system-packages
sudo pip install gevent --break-system-packages
sudo pip install flask --break-system-packages
sudo pip install pgrep --break-system-packages
sudo pip install suntime --break-system-packages
sudo pip install aiohttp_jinja2 --break-system-packages
--   not found sudo pip install dateutil --break-system-packages

# fix the conf.d directory for a future ftp
# not used # sudo chmod a+w /etc/mosquitto/conf.d

# now install zigbee2mqtt

https://www.zigbee2mqtt.io/guide/installation/01_linux.html

sudo apt-get install -y curl # should be builtin
sudo curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
# keyring problem?
wget https://deb.libre.computer/repo/pool/main/libr/libretech-keyring/libretech-keyring_2024.05.19_all.deb
sudo dpkg -i libretech-keyring_2024.05.19_all.deb
sudo apt update
#
sudo apt-get install -y nodejs git make g++ gcc libsystemd-dev
sudo corepack enable
sudo mkdir /opt/zigbee2mqtt
sudo chown -R ${USER}: /opt/zigbee2mqtt
git clone --depth 1 https://github.com/Koenkk/zigbee2mqtt.git /opt/zigbee2mqtt
cd /opt/zigbee2mqtt
pnpm install --frozen-lockfile  # this takes awhile
sudo snap install node --classic
cd /opt/zigbee2mqtt
pnpm start 
# its running
On first start, Zigbee2MQTT will start the onboarding on port 8080. Navigate to this board and configure accordingly


# change config to use home-broker.local for the broker
# broker has not been configured yet sshpass -p foobar sftp -oBatchMode=no -b install_files.bat jim@192.168.0.193



# now install home-broker code
sftp down the following (filezilla):

#  now done by mosquitto_manager.py # copy mosquitto.conf to /etc/mosquitto/conf.d

# bulk load of our code see "install_files.bat"
sshpass -p foobar sftp -oBatchMode=no -b install_files.bat jim@192.168.0.193


# this is a development environment
# and set things  up to auto start the home-broker on boot
# future may just run as a deamon but harder to debug.
#
code replace /dev/ttyUSB0 with your ZBC port 
edit  .bashrc 
add to the end

```
sudo python3 create_ipaddr_txt.py
sudo chmod a+rw /dev/ttyUSB0
echo booting in 10 seconds
sleep 10
sudo python3 main.py
date >> reboot_log.txt
sudo reboot
```


# Notes
# If replicating/copying prebuilt images make sure 
# the /opt/zigbee2mqtt/data stuff is fresh and not 
# a previous install
# configuration.yaml should be fresh
# coordinator_backup.json should be deleted
# Unsure about database.db or devices.db 

